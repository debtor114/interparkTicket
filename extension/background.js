// Î∞±Í∑∏ÎùºÏö¥Îìú Ïä§ÌÅ¨Î¶ΩÌä∏ - ÌÜµÌï© Î≤ÑÏ†Ñ
console.log('üé´ Ìã∞ÏºìÌåÖ Î™®ÎãàÌÑ∞ Background Script Î°úÎìúÎê®');

// ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠ Î™®ÎãàÌÑ∞ÎßÅ ÌÅ¥ÎûòÏä§
class NetworkRequestMonitor {
    constructor() {
        this.ticketingRequests = [];
        this.isMonitoring = false;
    }

    startMonitoring() {
        if (this.isMonitoring) return;
        this.isMonitoring = true;
        this.ticketingRequests = [];
        console.log('üéØ ÎÑ§Ìä∏ÏõåÌÅ¨ Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûëÎê®');
    }

    stopMonitoring() {
        if (!this.isMonitoring) return;
        this.isMonitoring = false;
        console.log('üõë ÎÑ§Ìä∏ÏõåÌÅ¨ Î™®ÎãàÌÑ∞ÎßÅ Ï§ëÏßÄÎê®');
    }

    handleRequest(details) {
        const requestData = {
            id: details.requestId,
            url: details.url,
            method: details.method,
            timestamp: Date.now(),
            type: this.categorizeRequest(details.url),
            resourceType: details.type,
            site: this.getSiteFromUrl(details.url),
            body: details.requestBody
        };

        if (this.isResourceToCapture(details.url, details.type)) {
            console.log(`üîç ${details.type.toUpperCase()} Î¶¨ÏÜåÏä§ Ï∫°Ï≤ò:`, requestData);
            this.ticketingRequests.push(requestData);
        }

        if (this.isTicketingRelated(details.url)) {
            console.log('üé´ Ìã∞ÏºìÌåÖ ÏöîÏ≤≠ Í∞êÏßÄ:', requestData);
            this.ticketingRequests.push(requestData);
        }
    }

    handleHeaders(details) {
        if (!this.isTicketingRelated(details.url) && !this.isResourceToCapture(details.url, details.type)) return;

        const request = this.ticketingRequests.find(r => r.id === details.requestId);
        if (request) {
            request.headers = details.requestHeaders;
        }
    }

    handleResponse(details) {
        if (!this.isTicketingRelated(details.url) && !this.isResourceToCapture(details.url, details.type)) return;

        const request = this.ticketingRequests.find(r => r.id === details.requestId);
        if (request) {
            request.statusCode = details.statusCode;
            request.responseHeaders = details.responseHeaders;
            request.completed = true;
            
            if (details.responseHeaders) {
                const contentType = details.responseHeaders.find(h => 
                    h.name.toLowerCase() === 'content-type');
                if (contentType) {
                    request.contentType = contentType.value;
                }
            }
        }

        if (this.isImportantTicketingRequest(details.url)) {
            this.notifyImportantRequest(request || {
                url: details.url,
                statusCode: details.statusCode
            });
        }
    }

    isTicketingRelated(url) {
        const ticketingPatterns = [
            '/ticket', '/booking', '/reserve', '/purchase', '/payment',
            '/order', '/seat', '/queue', '/api/v1', '/api/v2', 'ajax', 'json'
        ];
        return ticketingPatterns.some(pattern => 
            url.toLowerCase().includes(pattern.toLowerCase())
        );
    }

    isImportantTicketingRequest(url) {
        const importantPatterns = ['booking', 'reserve', 'purchase', 'payment', 'seat', 'queue'];
        return importantPatterns.some(pattern => 
            url.toLowerCase().includes(pattern.toLowerCase())
        );
    }

    isResourceToCapture(url, resourceType) {
        const captureTypes = ['stylesheet', 'script', 'main_frame', 'sub_frame'];
        const captureExtensions = ['.css', '.js', '.html', '.htm'];
        return captureTypes.includes(resourceType) || 
               captureExtensions.some(ext => url.toLowerCase().includes(ext));
    }

    categorizeRequest(url) {
        const lowerUrl = url.toLowerCase();
        if (lowerUrl.includes('.css')) return 'CSS';
        else if (lowerUrl.includes('.js')) return 'JAVASCRIPT';
        else if (lowerUrl.includes('.html') || lowerUrl.includes('.htm')) return 'HTML';
        else if (lowerUrl.includes('login') || lowerUrl.includes('auth')) return 'AUTH';
        else if (lowerUrl.includes('seat')) return 'SEAT';
        else if (lowerUrl.includes('booking') || lowerUrl.includes('reserve')) return 'BOOKING';
        else if (lowerUrl.includes('payment') || lowerUrl.includes('purchase')) return 'PAYMENT';
        else if (lowerUrl.includes('queue')) return 'QUEUE';
        else return 'OTHER';
    }

    getSiteFromUrl(url) {
        if (url.includes('interpark.com')) return 'interpark';
        else if (url.includes('ticketlink.co.kr')) return 'ticketlink';
        return 'unknown';
    }

    notifyImportantRequest(request) {
        chrome.action.setBadgeText({ text: '!' });
        chrome.action.setBadgeBackgroundColor({ color: '#FF0000' });
        console.log('üö® Ï§ëÏöî Ìã∞ÏºìÌåÖ ÏöîÏ≤≠ Í∞êÏßÄ:', request);
    }

    getRequests() {
        return this.ticketingRequests;
    }
}

// DOM Î∂ÑÏÑù Ï≤òÎ¶¨ ÌÅ¥ÎûòÏä§
class DOMAnalyzer {
    static async handleDOMAnalysis(analysisData, tab) {
        console.log('üîç DOM Î∂ÑÏÑù Í≤∞Í≥º ÏàòÏã†:', analysisData);
        
        await DOMAnalyzer.saveDOMAnalysis(analysisData, tab);
        DOMAnalyzer.updateSelectorPatterns(analysisData);
        
        const automationScript = DOMAnalyzer.generateAutomationScript(analysisData);
        console.log('‚úÖ DOM Î∂ÑÏÑù Ï≤òÎ¶¨ ÏôÑÎ£å');
        return automationScript;
    }

    static async saveDOMAnalysis(analysisData, tab) {
        const storageKey = `dom_analysis_${tab.id}_${Date.now()}`;
        const dataToSave = {
            ...analysisData,
            tabId: tab.id,
            tabUrl: tab.url,
            savedAt: new Date().toISOString()
        };

        try {
            await chrome.storage.local.set({
                [storageKey]: dataToSave,
                [`latest_analysis_${DOMAnalyzer.getSiteKey(analysisData.site)}`]: dataToSave
            });
            console.log('DOM Î∂ÑÏÑù Í≤∞Í≥º Ï†ÄÏû• ÏôÑÎ£å:', storageKey);
        } catch (error) {
            console.error('DOM Î∂ÑÏÑù Í≤∞Í≥º Ï†ÄÏû• Ïã§Ìå®:', error);
        }
    }

    static updateSelectorPatterns(analysisData) {
        const siteKey = DOMAnalyzer.getSiteKey(analysisData.site);
        console.log(`${siteKey} ÏÇ¨Ïù¥Ìä∏Ïùò ÏÖÄÎ†âÌÑ∞ Ìå®ÌÑ¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å`);
    }

    static generateAutomationScript(analysisData) {
        const script = {
            site: analysisData.site,
            url: analysisData.url,
            actions: []
        };

        if (analysisData.elements?.reservationButtons?.length > 0) {
            script.actions.push({
                type: 'click',
                target: 'reservationButton',
                description: 'ÏòàÎß§ Î≤ÑÌäº ÌÅ¥Î¶≠'
            });
        }

        return script;
    }

    static getSiteKey(site) {
        return site.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
    }
}

// Î©îÏù∏ ÎÑ§Ìä∏ÏõåÌÅ¨ Î™®ÎãàÌÑ∞ ÌÅ¥ÎûòÏä§
class NetworkMonitor {
    constructor() {
        this.isMonitoring = false;
        this.isExtensionEnabled = true;
        this.userEvents = [];
        this.loginStates = new Map();
        this.networkMonitor = new NetworkRequestMonitor();
        
        this.init();
    }

    async init() {
        const result = await chrome.storage.local.get(['isExtensionEnabled']);
        if (result.isExtensionEnabled !== undefined) {
            this.isExtensionEnabled = result.isExtensionEnabled;
        }

        this.setupMessageListener();
        this.setupTabListener();
        this.toggleMonitoringListeners();
    }

    setupMessageListener() {
        chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
            const safeResponse = (response) => {
                try {
                    if (sendResponse) {
                        sendResponse(response);
                    }
                } catch (error) {
                    console.warn('ÏùëÎãµ Ï†ÑÏÜ° Ïã§Ìå®:', error);
                }
            };

            try {
                switch(message.type) {
                    case 'LOGIN_STATUS_CHANGED':
                        this.handleLoginStatusChange(message.data, sender.tab);
                        safeResponse({success: true});
                        break;
                    case 'USER_EVENT_RECORDED':
                        this.handleUserEvent(message.data, sender.tab);
                        safeResponse({success: true});
                        break;
                    case 'START_MONITORING':
                        this.startMonitoring();
                        safeResponse({success: true});
                        break;
                    case 'STOP_MONITORING':
                        this.stopMonitoring();
                        safeResponse({success: true});
                        break;
                    case 'GET_REQUESTS':
                        safeResponse({requests: this.networkMonitor.getRequests()});
                        break;
                    case 'GET_EVENTS':
                        safeResponse({events: this.userEvents || []});
                        break;
                    case 'TOGGLE_EXTENSION':
                        this.isExtensionEnabled = message.isEnabled;
                        this.toggleMonitoringListeners();
                        safeResponse({success: true});
                        break;
                    case 'DOM_ANALYSIS_RESULT':
                        DOMAnalyzer.handleDOMAnalysis(message.data, sender.tab);
                        safeResponse({success: true});
                        break;
                    case 'PING':
                        // Ïó∞Í≤∞ ÌôïÏù∏Ïö© PING ÏùëÎãµ
                        safeResponse({success: true, message: 'pong'});
                        break;
                    default:
                        safeResponse({success: false, error: 'Unknown message type'});
                        break;
                }
            } catch (error) {
                console.error('Î©îÏãúÏßÄ Ï≤òÎ¶¨ Ïò§Î•ò:', error);
                safeResponse({error: error.message});
            }
            
            return true;
        });
    }

    setupTabListener() {
        // ÌÉ≠ ÏóÖÎç∞Ïù¥Ìä∏ Í∞êÏßÄ (ÏÉàÎ°úÏö¥ Ìã∞ÏºìÌåÖ ÏÇ¨Ïù¥Ìä∏ Î°úÎìú)
        chrome.tabs.onUpdated.addListener((tabId, changeInfo, tab) => {
            if (changeInfo.status === 'complete' && this.isTicketingSite(tab.url)) {
                console.log(`Ìã∞ÏºìÌåÖ ÏÇ¨Ïù¥Ìä∏ Î°úÎìú ÏôÑÎ£å: ${tab.url}`);
                this.handleNewTicketingTab(tab);
            }
        });

        // ÏÉàÎ°úÏö¥ ÌÉ≠ ÏÉùÏÑ± Í∞êÏßÄ
        chrome.tabs.onCreated.addListener((tab) => {
            if (this.isTicketingSite(tab.url)) {
                console.log(`ÏÉà Ìã∞ÏºìÌåÖ ÌÉ≠ ÏÉùÏÑ±: ${tab.url}`);
                this.handleNewTicketingTab(tab);
            }
        });

        // WebNavigation Ïù¥Î≤§Ìä∏ Í∞êÏßÄ (ÏÉà Ï∞Ω/ÌåùÏóÖ Ìè¨Ìï®)
        chrome.webNavigation.onCompleted.addListener((details) => {
            if (details.frameId === 0 && this.isTicketingSite(details.url)) {
                console.log(`WebNavigation ÏôÑÎ£å: ${details.url}`);
                this.handleWebNavigationCompleted(details);
            }
        });

        // Ï∞Ω ÏÉùÏÑ± Í∞êÏßÄ (ÌåùÏóÖ Ï∞Ω Ìè¨Ìï®)
        chrome.windows.onCreated.addListener((window) => {
            if (window.type === 'popup' || window.type === 'normal') {
                console.log('ÏÉà Ï∞Ω ÏÉùÏÑ± Í∞êÏßÄ:', window);
                // Ï∞ΩÏùò ÌÉ≠Îì§ÏùÑ ÌôïÏù∏ÌïòÏó¨ Ìã∞ÏºìÌåÖ ÏÇ¨Ïù¥Ìä∏Ïù∏ÏßÄ Ï≤¥ÌÅ¨
                chrome.tabs.query({windowId: window.id}, (tabs) => {
                    tabs.forEach(tab => {
                        if (this.isTicketingSite(tab.url)) {
                            console.log(`ÏÉà Ï∞ΩÏóêÏÑú Ìã∞ÏºìÌåÖ ÏÇ¨Ïù¥Ìä∏ Í∞êÏßÄ: ${tab.url}`);
                            this.handleNewTicketingTab(tab);
                        }
                    });
                });
            }
        });
    }

    toggleMonitoringListeners() {
        if (chrome.webRequest.onBeforeRequest.hasListener(this.handleRequestBound)) {
            chrome.webRequest.onBeforeRequest.removeListener(this.handleRequestBound);
        }
        if (chrome.webRequest.onBeforeSendHeaders.hasListener(this.handleHeadersBound)) {
            chrome.webRequest.onBeforeSendHeaders.removeListener(this.handleHeadersBound);
        }
        if (chrome.webRequest.onCompleted.hasListener(this.handleResponseBound)) {
            chrome.webRequest.onCompleted.removeListener(this.handleResponseBound);
        }

        if (this.isExtensionEnabled) {
            console.log('üåê WebRequest listeners enabled.');
            
            if (!this.handleRequestBound) {
                this.handleRequestBound = (details) => this.networkMonitor.handleRequest(details);
                this.handleHeadersBound = (details) => this.networkMonitor.handleHeaders(details);
                this.handleResponseBound = (details) => this.networkMonitor.handleResponse(details);
            }
            
            const urls = ["https://*.interpark.com/*", "https://*.ticketlink.co.kr/*"];
            const types = ["main_frame", "sub_frame", "stylesheet", "script", "image", "font", "object", "xmlhttprequest", "ping", "csp_report", "media", "websocket", "other"];

            chrome.webRequest.onBeforeRequest.addListener(this.handleRequestBound, {urls, types}, ["requestBody"]);
            chrome.webRequest.onBeforeSendHeaders.addListener(this.handleHeadersBound, {urls, types}, ["requestHeaders"]);
            chrome.webRequest.onCompleted.addListener(this.handleResponseBound, {urls, types}, ["responseHeaders"]);
        } else {
            console.log('üö´ WebRequest listeners disabled.');
        }
    }

    startMonitoring() {
        this.networkMonitor.startMonitoring();
        this.isMonitoring = true;
        this.userEvents = [];
        this.notifyAllTicketingTabs('MONITORING_STARTED');
    }

    stopMonitoring() {
        this.networkMonitor.stopMonitoring();
        this.isMonitoring = false;
        this.notifyAllTicketingTabs('MONITORING_STOPPED');
    }

    handleLoginStatusChange(data, tab) {
        this.loginStates.set(tab.id, data);
        console.log(`${data.site} Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú Î≥ÄÍ≤Ω:`, data);

        if (data.isLoggedIn && !this.isMonitoring) {
            this.startMonitoring();
            console.log('Î°úÍ∑∏Ïù∏ Í∞êÏßÄÎ°ú Ïù∏Ìïú Î™®ÎãàÌÑ∞ÎßÅ ÏûêÎèô ÏãúÏûë');
        }
    }

    handleUserEvent(eventData, tab) {
        const eventWithTabInfo = {
            ...eventData,
            tabId: tab.id,
            tabUrl: tab.url,
            site: this.getSiteFromUrl(tab.url)
        };

        this.userEvents.push(eventWithTabInfo);
        
        if (this.userEvents.length > 5000) {
            this.userEvents = this.userEvents.slice(-2500);
        }

        console.log('üìπ ÏÇ¨Ïö©Ïûê Ïù¥Î≤§Ìä∏ ÏàòÏã†:', eventWithTabInfo);

        if (this.isCriticalEvent(eventData)) {
            this.handleCriticalEvent(eventWithTabInfo);
        }
    }

    isCriticalEvent(eventData) {
        const criticalEvents = ['submit', 'click'];
        const criticalElementTypes = ['BUTTON', 'INPUT'];
        const criticalClasses = ['ticket', 'seat', 'booking', 'payment', 'buy', 'purchase'];
        const criticalTexts = ['ÏòàÎß§', 'Í≤∞Ï†ú', 'Íµ¨Îß§', 'Ï¢åÏÑù', 'Ìã∞Ïºì', 'Î°úÍ∑∏Ïù∏'];

        return criticalEvents.includes(eventData.type) &&
               (criticalElementTypes.includes(eventData.data?.elementType) ||
                criticalClasses.some(cls => eventData.data?.elementClass?.toLowerCase()?.includes(cls)) ||
                criticalTexts.some(text => eventData.data?.elementText?.toLowerCase()?.includes(text)));
    }

    handleCriticalEvent(eventData) {
        console.log('üö® Ï§ëÏöî ÏÇ¨Ïö©Ïûê Ïù¥Î≤§Ìä∏ Í∞êÏßÄ:', eventData);
        
        chrome.action.setBadgeText({ text: '!!' });
        chrome.action.setBadgeBackgroundColor({ color: '#FF4444' });

        setTimeout(() => {
            chrome.action.setBadgeText({ text: '' });
        }, 5000);
    }

    isTicketingSite(url) {
        if (!url) return false;
        const ticketingSites = [
            'interpark.com',
            'tickets.interpark.com',
            'tkglobal.interpark.com', 
            'poticket.interpark.com',
            'ticketlink.co.kr'
        ];
        return ticketingSites.some(site => url.includes(site));
    }

    // ÏÉàÎ°úÏö¥ Ìã∞ÏºìÌåÖ ÌÉ≠ Ï≤òÎ¶¨
    handleNewTicketingTab(tab) {
        if (!tab || !tab.id) return;

        console.log(`üé´ ÏÉà Ìã∞ÏºìÌåÖ ÌÉ≠ Ï≤òÎ¶¨: ${tab.url}`);
        
        // Î™®ÎãàÌÑ∞ÎßÅÏù¥ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏúºÎ©¥ ÏûêÎèôÏúºÎ°ú Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë
        if (this.isExtensionEnabled && !this.isMonitoring) {
            this.startMonitoring();
            console.log('ÏÉà Ìã∞ÏºìÌåÖ ÌÉ≠ÏúºÎ°ú Ïù∏Ìïú Î™®ÎãàÌÑ∞ÎßÅ ÏûêÎèô ÏãúÏûë');
        }

        // ÌÉ≠Ïóê ÌôïÏû• ÌîÑÎ°úÍ∑∏Îû® ÏÉÅÌÉú Ï†ÑÏÜ°
        setTimeout(() => {
            chrome.tabs.sendMessage(tab.id, {
                type: 'EXTENSION_STATUS',
                data: { 
                    isEnabled: this.isExtensionEnabled,
                    isMonitoring: this.isMonitoring 
                }
            }).catch(() => {
                console.log('ÏÉà ÌÉ≠Ïóê Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå® (ÏïÑÏßÅ Î°úÎìúÎêòÏßÄ ÏïäÏùå)');
            });
        }, 2000);

        // Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
        if (this.isTicketingBookingUrl(tab.url)) {
            chrome.action.setBadgeText({ text: 'üéØ' });
            chrome.action.setBadgeBackgroundColor({ color: '#4CAF50' });
            console.log('üéØ ÏòàÎß§ ÌéòÏù¥ÏßÄ Ï†ëÍ∑º Í∞êÏßÄ');
        }
    }

    // WebNavigation ÏôÑÎ£å Ï≤òÎ¶¨
    handleWebNavigationCompleted(details) {
        console.log(`üåê WebNavigation ÏôÑÎ£å: ${details.url}`);
        
        // ÏòàÎß§ Í¥ÄÎ†® ÌéòÏù¥ÏßÄÏù∏ÏßÄ ÌôïÏù∏
        if (this.isTicketingBookingUrl(details.url)) {
            console.log('üé´ ÏòàÎß§ ÌéòÏù¥ÏßÄ WebNavigation Í∞êÏßÄ');
            chrome.action.setBadgeText({ text: 'üìù' });
            chrome.action.setBadgeBackgroundColor({ color: '#FF9800' });
        }
    }

    // ÏòàÎß§/Í≤∞Ï†ú Í¥ÄÎ†® URL ÌôïÏù∏
    isTicketingBookingUrl(url) {
        if (!url) return false;
        const bookingPatterns = [
            'BookMain.asp',
            '/ticket/',
            '/booking/',
            '/reserve/',
            '/seat/',
            '/payment/',
            'poticket.interpark.com'
        ];
        return bookingPatterns.some(pattern => url.includes(pattern));
    }

    getSiteFromUrl(url) {
        if (url.includes('interpark.com')) return 'interpark';
        else if (url.includes('ticketlink.co.kr')) return 'ticketlink';
        return 'unknown';
    }

    async notifyAllTicketingTabs(message) {
        try {
            const tabs = await chrome.tabs.query({
                url: ["https://*.interpark.com/*", "https://*.ticketlink.co.kr/*"]
            });

            for (let tab of tabs) {
                chrome.tabs.sendMessage(tab.id, {
                    type: message,
                    data: { isMonitoring: this.isMonitoring }
                }).catch(() => {
                    // ÌÉ≠Ïù¥ ÏùëÎãµÌïòÏßÄ ÏïäÎäî Í≤ΩÏö∞ Î¨¥Ïãú
                });
            }
        } catch (error) {
            console.error('ÌÉ≠ ÏïåÎ¶º Ïò§Î•ò:', error);
        }
    }
}

// Extension ÏãúÏûë Ïãú Î™®ÎãàÌÑ∞ Ï¥àÍ∏∞Ìôî
const networkMonitor = new NetworkMonitor();

// Extension ÏÑ§Ïπò/ÏóÖÎç∞Ïù¥Ìä∏ Ïãú Ï≤òÎ¶¨
chrome.runtime.onInstalled.addListener(() => {
    console.log('Ìã∞ÏºìÌåÖ Î™®ÎãàÌÑ∞ Extension ÏÑ§Ïπò ÏôÑÎ£å');
    chrome.action.setBadgeText({ text: '' });
});